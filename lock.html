<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
<style>
  body {
    background-color: #FEFEFE;
    font: #222;
    font-size: 18px;
    margin: 40px;
    font-family: Helvetica;
  }
</style>
</head>

<body>
  <div>CONSOLE LOG <button id="clear">Clear</button></div>
  <pre id="output"></pre>
  <script>
    const getSeconds = () => {
      return Math.round(Date.now() / 1000)
    }
    function padLeft(nr, n, str){
        return Array(n-String(nr).length+1).join(str||'0')+nr;
    }
    const start = getSeconds()
    const getTimestamp = () => {
      const seconds = getSeconds() - start
      const mins = Math.floor(seconds / 60)
      const secs = seconds % 60
      const pad = "00"
      return `${padLeft(mins, 2)}:${padLeft(secs, 2)}`
    }
    const output = document.getElementById("output")
    const button = document.getElementById("clear")
    button.onclick = () => {
      while (output.firstChild) {
        output.removeChild(output.lastChild)
      }
    }
    
    const debug = (msg) => {
      const message = document.createElement("div")
      message.innerText = `+${getTimestamp()} ${msg}`
      output.appendChild(message)
    }
    debug("Page has loaded")
    
    let hidden = ""
    let visibilityChange = ""
    if ("hidden" in document) {
        hidden = "hidden"
        visibilityChange = "visibilitychange"
    } else if ("msHidden" in document) {
        hidden = "msHidden"
        visibilityChange = "msvisibilitychange"
    } else if ("webkitHidden" in document) {
        hidden = "webkitHidden"
        visibilityChange = "webkitvisibilitychange"
    }

    let isTabActive = true
    if (hidden !== "" && visibilityChange !== "") {
        debug("Using visibility change event")
        document.addEventListener(visibilityChange, () => {
            if (document[hidden]) {
                debug("Document Visibility Change: Hidden")
                isTabActive = false
            } else {
                debug("Document Visiblity Change: Visible")
                isTabActive = true
            }
            documentVisibilityChange.fire(isTabActive)
        })
    } else {
        debug("Falling back to blur/focus")
        // Use window blur/focus events as fallback for document.hidden
        window.addEventListenerPoly("blur", () => {
            isTabActive = false
            debug("Document blurred")
            documentVisibilityChange.fire(isTabActive)
        })

        window.addEventListenerPoly("focus", () => {
            isTabActive = true
            debug("Document Focused")
            documentVisibilityChange.fire(isTabActive)
        })
    }
  </script>
</body>
</html>
