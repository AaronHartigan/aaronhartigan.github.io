<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
<style>
  body {
    background-color: #FCFCFC;
    font: #222;
    font-size: 18px;
    margin: 40px;
    font-family: Helvetica;
  }
</style>
</head>

<body>
  <div>CONSOLE LOG</div>
  <div id="output"></div>
  <script>
    const debug = (msg) => {
      const output = document.getElementById("output")
      const message = document.createElement("div")
      message.innerText = msg
      output.appendChild(message)
    }
    debug("Page has loaded")
    
    let hidden = ""
    let visibilityChange = ""
    if ("hidden" in document) {
        hidden = "hidden"
        visibilityChange = "visibilitychange"
    } else if ("msHidden" in document) {
        hidden = "msHidden"
        visibilityChange = "msvisibilitychange"
    } else if ("webkitHidden" in document) {
        hidden = "webkitHidden"
        visibilityChange = "webkitvisibilitychange"
    }

    let isTabActive = true
    if (hidden !== "" && visibilityChange !== "") {
        console.log("Using visibility change event")
        addEventListenerPoly(visibilityChange, document, () => {
            if (document[hidden]) {
                debug("Document Visibility Change: Hidden")
                isTabActive = false
            } else {
                debug("Document Visiblity Change: Visible")
                isTabActive = true
            }
            documentVisibilityChange.fire(isTabActive)
        })
    } else {
        console.log("Falling back to blur/focus")
        // Use window blur/focus events as fallback for document.hidden
        addEventListenerPoly("blur", window, () => {
            isTabActive = false
            debug("Document blurred")
            documentVisibilityChange.fire(isTabActive)
        })

        addEventListenerPoly("focus", window, () => {
            isTabActive = true
            debug("Document Focused")
            documentVisibilityChange.fire(isTabActive)
        })
    }
  </script>
</body>
</html>
